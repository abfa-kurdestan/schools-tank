<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Water Tank - ØªØ§Ù†Ú©Ø±Ù‡Ø§ÛŒ Ø¢Ø¨</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="style.css?v=1.3">

  <style>
    body {
      touch-action: none;
    }
  </style>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js" defer></script>
  <script src="data.js" defer></script>
</head>

<body>

  <header class="site-header">
    <div class="header-content">
      <i class="fas fa-faucet-drip"></i>
      <h1>ØªØ§Ù†Ú©Ø±Ù‡Ø§ÛŒ Ù‡Ø²Ø§Ø±Ù„ÛŒØªØ±ÛŒ Ù…Ø³ØªÙ‚Ø± Ø¯Ø± Ù…Ø¯Ø§Ø±Ø³ Ø´Ù‡Ø± Ø¨Ø§Ù†Ù‡</h1>
    </div>
  </header>

  <div id="map"></div>
  <!-- Ø¯Ú©Ù…Ù‡ Ù‡Ø§ÛŒ ØªØºÛŒÛŒØ± Ù†Ù‚Ø´Ù‡ Ùˆ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù† -->

  <div class="map-toggle-wrapper top-right">
    <span class="toggle-label">ØªØºÛŒÛŒØ± Ù†Ù‚Ø´Ù‡</span>
    <label class="switch">
      <input type="checkbox" id="layerCheckbox" onchange="toggleTileLayer()">
      <span class="slider round"></span>
    </label>
  </div>

  <div id="locate-btn" class="custom-control-btn bottom-center" onclick="locateUser()">
    <i class="fas fa-crosshairs"></i>
  </div>

  <!-- legend  -->
  <div id="legend">
    <div class="legend-item">
      <div class="school-icon"> <i class="fas fa-school"></i>
      </div>
      <span> Ù…Ø¯Ø±Ø³Ù‡ </span>
    </div>


    <!-- legend finish -->

    <script>
      // Ú†ÙˆÙ† Ø§Ø² defer Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ø±Ø¯ÛŒÙ…ØŒ Ù…Ù†ØªØ¸Ø± Ù„ÙˆØ¯ Ú©Ø§Ù…Ù„ Ù…ÛŒâ€ŒÙ…Ø§Ù†ÛŒÙ…
      document.addEventListener('DOMContentLoaded', function () {

        // ØªØ³Øª Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ ÙØ§ÛŒÙ„ Ø¯ÛŒØªØ§ Ø¯Ø±Ø³Øª Ù„ÙˆØ¯ Ø´Ø¯Ù‡ØŸ
        if (typeof waterPoints === 'undefined') {
          console.error("ÙØ§ÛŒÙ„ data.js Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!");
          alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª.");
          return;
        }

        // === 1. ØªØ¹Ø±ÛŒÙ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù†Ù‚Ø´Ù‡ ===
        const cartoLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
          attribution: 'Â© CartoDB',
          maxZoom: 19
        });

        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap',
          maxZoom: 19
        });

        // === 2. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù†Ù‚Ø´Ù‡ ===
        const map = L.map('map', {
          zoomControl: false,
          layers: [cartoLayer]
        }).setView([35.997, 45.887], 14);

        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        let isCarto = true;



        // Ù…ØªØºÛŒØ± Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø³ÙˆÛŒÛŒÚ† Ù†Ù‚Ø´Ù‡
        // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø§Ù„Ø§Ù† Ú†Ú© Ù…ÛŒÚ©Ù†Ù‡ Ø¯Ú©Ù…Ù‡ Ø±ÙˆØ´Ù† Ù‡Ø³Øª ÛŒØ§ Ø®Ø§Ù…ÙˆØ´
        window.toggleTileLayer = function () {
          const checkbox = document.getElementById('layerCheckbox');

          if (checkbox.checked) {
            // Ø§Ú¯Ø± ØªÛŒÚ© Ø®ÙˆØ±Ø¯Ù‡ Ø¨ÙˆØ¯ (Ø§Ø³Ù„Ø§ÛŒØ¯ Ø´Ø¯)ØŒ Ø¨Ø±Ùˆ Ø±ÙˆÛŒ Ø­Ø§Ù„Øª OSM
            map.removeLayer(cartoLayer);
            map.addLayer(osmLayer);
          } else {
            // Ø§Ú¯Ø± ØªÛŒÚ© Ù†Ø¯Ø§Ø´ØªØŒ Ø¨Ø±Ú¯Ø±Ø¯ Ø¨Ù‡ Ø­Ø§Ù„Øª Carto
            map.removeLayer(osmLayer);
            map.addLayer(cartoLayer);
          }
        };

        // === 3. ØªØ¹Ø±ÛŒÙ Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ ===
        const icon10k = L.divIcon({
          className: 'icon-10k',
          html: "<div class='water-icon'><i class='fas fa-glass-water'></i></div>",
          iconSize: [32, 32],
          iconAnchor: [16, 16],
          popupAnchor: [0, -10]
        });

        const icon5k = L.divIcon({
          className: 'icon-5k',
          html: "<div class='water-icon-5k'><i class='fas fa-glass-water'></i></div>",
          iconSize: [32, 32],
          iconAnchor: [16, 16],
          popupAnchor: [0, -10]
        });

        const iconSchool = L.divIcon({
          className: 'icon-school',
          html: "<div class='school-icon'><i class='fas fa-school'></i></div>",
          iconSize: [20, 20],
          iconAnchor: [10, 10],
          popupAnchor: [0, -8]
        });

        // === 4. ØªÙˆØ§Ø¨Ø¹ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ ===
        window.shareLocation = function (lat, lng, name) {
          // Ø§ØµÙ„Ø§Ø­ Ù„ÛŒÙ†Ú© Ú¯ÙˆÚ¯Ù„ Ù…Ù¾ Ø¨Ø±Ø§ÛŒ Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø±ÛŒ
          const mapLink = `https://www.google.com/maps?q=${lat},${lng}`;
          const shareData = {
            title: 'Ù…ÙˆÙ‚Ø¹ÛŒØª ØªØ§Ù†Ú©Ø± Ø¢Ø¨',
            text: `ğŸ“ ${name}\n`,
            url: mapLink
          };
          if (navigator.share) {
            navigator.share(shareData).catch(console.error);
          } else {
            navigator.clipboard.writeText(mapLink).then(() => alert('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯!'));
          }
        };

        // === 5. Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„Ø§Ø³ØªØ± Ù…Ø§Ø±Ú©Ø±Ù‡Ø§ ===
        const markersCluster = L.markerClusterGroup({
          showCoverageOnHover: false,
          spiderfyOnMaxZoom: true,
          disableClusteringAtZoom: 18
        });

        waterPoints.forEach(point => {
          if (!point.lat || !point.lng) return;

          let iconToUse = icon10k;
          if (point.type === "5k") iconToUse = icon5k;
          if (point.type === "school") iconToUse = iconSchool;

          const marker = L.marker([point.lat, point.lng], { icon: iconToUse });

          // Ø§ØµÙ„Ø§Ø­ Ù„ÛŒÙ†Ú© Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ú¯ÙˆÚ¯Ù„ Ù…Ù¾ (Ø¨Ø§Ú¯ Ù‚Ø¨Ù„ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ø±ÙØ¹ Ø´Ø¯)
          const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${point.lat},${point.lng}`;

          const popupContent = `
                <div class="popup-content">
                  <h3>${point.name}</h3>
                  <p>Ù†ÙˆØ¹: ${point.schoolType || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                  <p>${point.address || ''}</p>
                  <a href="${googleMapsUrl}" target="_blank" class="navigate-btn">
                    <i class="fas fa-location-arrow"></i> Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ
                  </a>
                  <button class="share-btn" onclick="shareLocation(${point.lat}, ${point.lng}, '${point.name}')">
                    <i class="fas fa-share-nodes"></i> Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ
                  </button>
                </div>
            `;

          marker.bindPopup(popupContent, { className: 'custom-popup' });
          markersCluster.addLayer(marker);
        });

        map.addLayer(markersCluster);

        let userMarker = null;

        // === 6. Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ Ú©Ø§Ø±Ø¨Ø± (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ùˆ Ù‚ÙˆÛŒâ€ŒØªØ±) ===

        window.locateUser = function () {
          if (!navigator.geolocation) {
            alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ù‚Ø¯ÛŒÙ…ÛŒ Ø§Ø³Øª Ùˆ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.");
            return;
          }

          const btnIcon = document.querySelector('#locate-btn i');
          // Ø­Ø§Ù„Øª Ù„ÙˆØ¯ÛŒÙ†Ú¯
          btnIcon.classList.remove('fa-crosshairs');
          btnIcon.classList.add('fa-spinner', 'fa-spin');

          // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ
          const options = {
            enableHighAccuracy: true, // Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§ GPS Ø¯Ù‚ÛŒÙ‚
            timeout: 15000,           // 15 Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù† (Ù‚Ø¨Ù„Ø§Ù‹ 5 Ø¨ÙˆØ¯)
            maximumAge: 10000         // Ø§Ú¯Ø± Ù„ÙˆÚ©ÛŒØ´Ù† 10 Ø«Ø§Ù†ÛŒÙ‡ Ù¾ÛŒØ´ Ø±Ø§ Ø¯Ø§Ø±ÛŒØŒ Ù‡Ù…Ø§Ù† Ø±Ø§ Ø¨Ø¯Ù‡ (Ø³Ø±ÛŒØ¹â€ŒØªØ±)
          };

          function success(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            // Ø²ÙˆÙ… Ø±ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±
            map.setView([lat, lng], 16);

            // Ø­Ø°Ù Ù…Ø§Ø±Ú©Ø± Ù‚Ø¨Ù„ÛŒ
            if (userMarker) map.removeLayer(userMarker);

            // Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø§Ø±Ú©Ø± Ø¬Ø¯ÛŒØ¯ (Ø¯Ø§ÛŒØ±Ù‡ Ù†Ø§Ø±Ù†Ø¬ÛŒ)
            userMarker = L.circleMarker([lat, lng], {
              radius: 10,
              fillColor: "#ff5722",
              color: "#fff",
              weight: 3,
              opacity: 1,
              fillOpacity: 0.8
            }).addTo(map);

            userMarker.bindPopup("Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ù…Ø§").openPopup();

            // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¢ÛŒÚ©ÙˆÙ† Ø¯Ú©Ù…Ù‡
            btnIcon.classList.remove('fa-spinner', 'fa-spin');
            btnIcon.classList.add('fa-crosshairs');
          }

          function error(err) {
            // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¢ÛŒÚ©ÙˆÙ† Ø¯Ú©Ù…Ù‡
            btnIcon.classList.remove('fa-spinner', 'fa-spin');
            btnIcon.classList.add('fa-crosshairs');

            // ØªØ´Ø®ÛŒØµ Ø¯Ù‚ÛŒÙ‚ Ø¹Ù„Øª Ø®Ø·Ø§
            if (err.code === 1) {
                alert("Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ Ø±Ø§ Ø±Ø¯ Ú©Ø±Ø¯ÛŒØ¯.");
            } else if (err.code === 2) {
                alert("Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ Ø´Ù…Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ (GPS Ø®Ø§Ù…ÙˆØ´ Ø§Ø³ØªØŸ).");
            } else if (err.code === 3) {
                alert("Ø²Ù…Ø§Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªÙ…Ø§Ù… Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
                // Ù†Ú©ØªÙ‡: Ø§Ú¯Ø± Ø§ÛŒÙ† Ø®Ø·Ø§ Ø²ÛŒØ§Ø¯ Ø±Ø® Ø¯Ø§Ø¯ØŒ ÛŒØ¹Ù†ÛŒ Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ GPS Ø¶Ø¹ÛŒÙ Ø§Ø³Øª
            } else {
                alert("Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª.");
            }
            console.warn(`ERROR(${err.code}): ${err.message}`);
          }

          navigator.geolocation.getCurrentPosition(success, error, options);
        };

      });
    </script>
</body>

</html>