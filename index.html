<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ØªØ§Ù†Ú©Ø±Ù‡Ø§ÛŒ Ø¢Ø¨</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="style.css?v=1.3">

  <style>
    body {
      touch-action: none;
    }
  </style>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js" defer></script>
  <script src="data.js" defer></script>
</head>

<body>

  <header class="site-header">
    <div class="header-content">
      <i class="fas fa-faucet-drip"></i>
      <h1>ØªØ§Ù†Ú©Ø±Ù‡Ø§ÛŒ Ù‡Ø²Ø§Ø±Ù„ÛŒØªØ±ÛŒ Ù…Ø³ØªÙ‚Ø± Ø¯Ø± Ù…Ø¯Ø§Ø±Ø³ Ø´Ù‡Ø± Ø¨Ø§Ù†Ù‡</h1>
    </div>
  </header>

  <div id="map"></div>
  <!-- Ø¯Ú©Ù…Ù‡ Ù‡Ø§ÛŒ ØªØºÛŒÛŒØ± Ù†Ù‚Ø´Ù‡ Ùˆ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù† -->

  <div class="map-toggle-wrapper top-right">
    <span class="toggle-label">ØªØºÛŒÛŒØ± Ù†Ù‚Ø´Ù‡</span>
    <label class="switch">
      <input type="checkbox" id="layerCheckbox" onchange="toggleTileLayer()">
      <span class="slider round"></span>
    </label>
  </div>

  <div id="locate-btn" class="custom-control-btn bottom-center" onclick="locateUser()">
    <i class="fas fa-crosshairs"></i>
  </div>


  <a href="https://t.me/Carwan" target="_blank" class="support-btn top-left">
    <i class="fab fa-telegram-plane"></i>
  </a>
  <!-- legend  -->
  <div id="legend">
    <div class="legend-item">
      <div class="school-icon"> <i class="fas fa-school"></i>
      </div>
      <span> Ù…Ø¯Ø±Ø³Ù‡ </span>
    </div>


    <!-- legend finish -->

    <script>
      // Ú†ÙˆÙ† Ø§Ø² defer Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ø±Ø¯ÛŒÙ…ØŒ Ù…Ù†ØªØ¸Ø± Ù„ÙˆØ¯ Ú©Ø§Ù…Ù„ Ù…ÛŒâ€ŒÙ…Ø§Ù†ÛŒÙ…
      document.addEventListener('DOMContentLoaded', function () {

        // ØªØ³Øª Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ ÙØ§ÛŒÙ„ Ø¯ÛŒØªØ§ Ø¯Ø±Ø³Øª Ù„ÙˆØ¯ Ø´Ø¯Ù‡ØŸ
        if (typeof waterPoints === 'undefined') {
          console.error("ÙØ§ÛŒÙ„ data.js Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!");
          alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª.");
          return;
        }

        // === 1. ØªØ¹Ø±ÛŒÙ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù†Ù‚Ø´Ù‡ ===
        const cartoLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
          attribution: 'Â© CartoDB',
          maxZoom: 19
        });

        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap',
          maxZoom: 19
        });

        // === 2. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù†Ù‚Ø´Ù‡ ===
        const map = L.map('map', {
          zoomControl: false,
          layers: [cartoLayer]
        }).setView([35.997, 45.887], 14);

        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        let isCarto = true;



        // Ù…ØªØºÛŒØ± Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø³ÙˆÛŒÛŒÚ† Ù†Ù‚Ø´Ù‡
        // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø§Ù„Ø§Ù† Ú†Ú© Ù…ÛŒÚ©Ù†Ù‡ Ø¯Ú©Ù…Ù‡ Ø±ÙˆØ´Ù† Ù‡Ø³Øª ÛŒØ§ Ø®Ø§Ù…ÙˆØ´
        window.toggleTileLayer = function () {
          const checkbox = document.getElementById('layerCheckbox');

          if (checkbox.checked) {
            // Ø§Ú¯Ø± ØªÛŒÚ© Ø®ÙˆØ±Ø¯Ù‡ Ø¨ÙˆØ¯ (Ø§Ø³Ù„Ø§ÛŒØ¯ Ø´Ø¯)ØŒ Ø¨Ø±Ùˆ Ø±ÙˆÛŒ Ø­Ø§Ù„Øª OSM
            map.removeLayer(cartoLayer);
            map.addLayer(osmLayer);
          } else {
            // Ø§Ú¯Ø± ØªÛŒÚ© Ù†Ø¯Ø§Ø´ØªØŒ Ø¨Ø±Ú¯Ø±Ø¯ Ø¨Ù‡ Ø­Ø§Ù„Øª Carto
            map.removeLayer(osmLayer);
            map.addLayer(cartoLayer);
          }
        };

        // === 3. ØªØ¹Ø±ÛŒÙ Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ ===
        const icon10k = L.divIcon({
          className: 'icon-10k',
          html: "<div class='water-icon'><i class='fas fa-glass-water'></i></div>",
          iconSize: [32, 32],
          iconAnchor: [16, 16],
          popupAnchor: [0, -10]
        });

        const icon5k = L.divIcon({
          className: 'icon-5k',
          html: "<div class='water-icon-5k'><i class='fas fa-glass-water'></i></div>",
          iconSize: [32, 32],
          iconAnchor: [16, 16],
          popupAnchor: [0, -10]
        });

        const iconSchool = L.divIcon({
          className: 'icon-school',
          html: "<div class='school-icon'><i class='fas fa-school'></i></div>",
          iconSize: [20, 20],
          iconAnchor: [10, 10],
          popupAnchor: [0, -8]
        });

        // === 4. ØªÙˆØ§Ø¨Ø¹ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ ===
        window.shareLocation = function (lat, lng, name) {
          // Ø§ØµÙ„Ø§Ø­ Ù„ÛŒÙ†Ú© Ú¯ÙˆÚ¯Ù„ Ù…Ù¾ Ø¨Ø±Ø§ÛŒ Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø±ÛŒ
          const mapLink = `https://www.google.com/maps?q=${lat},${lng}`;
          const shareData = {
            title: 'Ù…ÙˆÙ‚Ø¹ÛŒØª ØªØ§Ù†Ú©Ø± Ø¢Ø¨',
            text: `ğŸ“ ${name}\n`,
            url: mapLink
          };
          if (navigator.share) {
            navigator.share(shareData).catch(console.error);
          } else {
            navigator.clipboard.writeText(mapLink).then(() => alert('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯!'));
          }
        };

        // === 5. Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„Ø§Ø³ØªØ± Ù…Ø§Ø±Ú©Ø±Ù‡Ø§ ===
        // === 5. Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„Ø§Ø³ØªØ± Ù…Ø§Ø±Ú©Ø±Ù‡Ø§ (Ø¨Ø§ Ø¢ÛŒÚ©ÙˆÙ† Ø³ÙØ§Ø±Ø´ÛŒ Ù…Ø¯Ø±Ø³Ù‡) ===
        const markersCluster = L.markerClusterGroup({
          showCoverageOnHover: false,
          spiderfyOnMaxZoom: true,
          disableClusteringAtZoom: 18,

          // ØªØ§Ø¨Ø¹ Ø³Ø§Ø®Øª Ø¢ÛŒÚ©ÙˆÙ† Ú©Ù„Ø§Ø³ØªØ± Ø³ÙØ§Ø±Ø´ÛŒ
          iconCreateFunction: function (cluster) {
            const count = cluster.getChildCount();

            // Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø¢ÛŒÚ©ÙˆÙ† Ù…Ø¯Ø±Ø³Ù‡ Ø±Ø§ Ù‡Ù…Ø±Ø§Ù‡ Ø¨Ø§ Ø¹Ø¯Ø¯ (badge) Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†ÛŒÙ…
            return L.divIcon({
              html: `
                <div class='cluster-wrapper'>
                   <div class='school-icon'><i class='fas fa-school'></i></div>
                   <span class='cluster-badge'>${count}</span>
                </div>
              `,
              className: 'marker-cluster-custom', // Ú©Ù„Ø§Ø³ÛŒ Ú©Ù‡ Ø¯Ø± CSS ØªØ¹Ø±ÛŒÙ Ú©Ø±Ø¯ÛŒÙ…
              iconSize: [32, 32],
              iconAnchor: [16, 16]
            });
          }
        });

        waterPoints.forEach(point => {
          if (!point.lat || !point.lng) return;

          let iconToUse = icon10k;
          if (point.type === "5k") iconToUse = icon5k;
          if (point.type === "school") iconToUse = iconSchool;

          const marker = L.marker([point.lat, point.lng], { icon: iconToUse });

          // Ø§ØµÙ„Ø§Ø­ Ù„ÛŒÙ†Ú© Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ú¯ÙˆÚ¯Ù„ Ù…Ù¾ (Ø¨Ø§Ú¯ Ù‚Ø¨Ù„ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ø±ÙØ¹ Ø´Ø¯)
          const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${point.lat},${point.lng}`;

          const popupContent = `
                <div class="popup-content">
                  <h3>${point.name}</h3>
                  <p>Ù†ÙˆØ¹: ${point.schoolType || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                  <p>${point.address || ''}</p>
                  <a href="${googleMapsUrl}" target="_blank" class="navigate-btn">
                    <i class="fas fa-location-arrow"></i> Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ
                  </a>
                  <button class="share-btn" onclick="shareLocation(${point.lat}, ${point.lng}, '${point.name}')">
                    <i class="fas fa-share-nodes"></i> Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ
                  </button>
                </div>
            `;

          marker.bindPopup(popupContent, { className: 'custom-popup' });
          markersCluster.addLayer(marker);
        });

        map.addLayer(markersCluster);

        let userMarker = null;

        // === 6. Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ Ú©Ø§Ø±Ø¨Ø± (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ùˆ Ù‚ÙˆÛŒâ€ŒØªØ±) ===

        // === 6. Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ Ú©Ø§Ø±Ø¨Ø± (Ù†Ø³Ø®Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ùˆ Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ) ===
        window.locateUser = function () {
          if (!navigator.geolocation) {
            alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ù‚Ø¯ÛŒÙ…ÛŒ Ø§Ø³Øª Ùˆ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.");
            return;
          }

          const btnIcon = document.querySelector('#locate-btn i');
          // Ø­Ø§Ù„Øª Ù„ÙˆØ¯ÛŒÙ†Ú¯
          btnIcon.classList.remove('fa-crosshairs');
          btnIcon.classList.add('fa-spinner', 'fa-spin');

          // ØªØ§Ø¨Ø¹ Ù…ÙˆÙÙ‚ÛŒØª (Ù…Ø´ØªØ±Ú©)
          function success(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            // Ø²ÙˆÙ… Ø±ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±
            map.setView([lat, lng], 16);

            if (userMarker) map.removeLayer(userMarker);

            userMarker = L.circleMarker([lat, lng], {
              radius: 10,
              fillColor: "#ff5722",
              color: "#fff",
              weight: 3,
              opacity: 1,
              fillOpacity: 0.8
            }).addTo(map);

            userMarker.bindPopup("Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ù…Ø§").openPopup();

            // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¢ÛŒÚ©ÙˆÙ†
            btnIcon.classList.remove('fa-spinner', 'fa-spin');
            btnIcon.classList.add('fa-crosshairs');
          }

          // ØªØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
          function handleError(err, isHighAccuracy) {
            // Ø§Ú¯Ø± ØªÙ„Ø§Ø´ Ø§ÙˆÙ„ (Ø¯Ù‚ÛŒÙ‚) Ø¨ÙˆØ¯ Ùˆ ØªØ§ÛŒÙ…â€ŒØ§ÙˆØª Ø´Ø¯ØŒ Ø­Ø§Ù„Ø§ ØªÙ„Ø§Ø´ Ø¯ÙˆÙ… (ØªÙ‚Ø±ÛŒØ¨ÛŒ) Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡
            if (isHighAccuracy && (err.code === 3 || err.code === 2)) {
              console.log("GPS failed, trying low accuracy...");
              navigator.geolocation.getCurrentPosition(
                success,
                (finalErr) => handleError(finalErr, false), // Ø§Ú¯Ø± Ø¨Ø§Ø² Ù‡Ù… Ø®Ø·Ø§ Ø¯Ø§Ø¯
                {
                  enableHighAccuracy: false, // Ø§ÛŒÙ† Ø¨Ø§Ø± Ø¯Ù‚Øª Ù¾Ø§ÛŒÛŒÙ† (Ø³Ø±ÛŒØ¹â€ŒØªØ±)
                  timeout: 10000,
                  maximumAge: 0
                }
              );
              return;
            }

            // Ø§Ú¯Ø± ØªÙ„Ø§Ø´ Ø¯ÙˆÙ… Ù‡Ù… Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯ ÛŒØ§ Ø®Ø·Ø§ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…Ø¬ÙˆØ² (Permission) Ø¨ÙˆØ¯:
            btnIcon.classList.remove('fa-spinner', 'fa-spin');
            btnIcon.classList.add('fa-crosshairs');

            if (err.code === 1) {
              alert("Ù„Ø·ÙØ§Ù‹ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ (GPS) Ø±Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.");
            } else if (err.code === 2) {
              alert("Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ù…Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ GPS Ø±Ø§ Ø±ÙˆØ´Ù† Ú©Ù†ÛŒØ¯.");
            } else if (err.code === 3) {
              alert("Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ GPS Ø¶Ø¹ÛŒÙ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯Ø± ÙØ¶Ø§ÛŒ Ø¨Ø§Ø² Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.");
            } else {
              alert("Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡.");
            }
          }

          // ØªÙ„Ø§Ø´ Ø§ÙˆÙ„: Ø¨Ø§ Ø¯Ù‚Øª Ø¨Ø§Ù„Ø§ (High Accuracy)
          navigator.geolocation.getCurrentPosition(
            success,
            (err) => handleError(err, true),
            {
              enableHighAccuracy: true,
              timeout: 10000, // Û±Û° Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ GPS ØµØ¨Ø± Ú©Ù†
              maximumAge: 0
            }
          );
        };

      });
    </script>
</body>

</html>